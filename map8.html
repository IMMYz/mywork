<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=DE0abf6cf5580f24857faef21a4b3870"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<link type="text/css" rel="stylesheet" href="bootstrap/css/bootstrap.css">
<link type="text/css" rel="stylesheet" href="bootstrap/js/bootstrap-silder/bootstrap-slider.css"></link>
<script type="text/javascript" src="bootstrap/js/bootstrap-silder/bootstrap-slider.js"></script>
<script type="text/javascript" src="bootstrap/js/bootstrap.js"></script>
<style>
    body,html{
        width:100%;
        height:100%
    }
    #allmap{
        width:50%;
        height:100%;
        margin:0 auto;
        top:240px;
    }
    #control{
        position:absolute;
        left:0
    }
    .slider.slider-horizontal{
        width:1200px;
    }
    .slider-tick-label-container{
        display:none;
    }
</style>
<body>
<div id="control" class="container-fluid">
    <input id="time" type="text" />
    <button type="button" onclick="start()">开始</button>
    <button type="button" onclick="plus()">+1时间</button>

    <div class="row">
        <div>
            分割份数：
        </div>
        <input type="text" class="form-control" id="share">
        <div id="nowTime">

        </div>
        <div class="col-md-12">
            <input id="ex8" type="text"/>
        </div>
        <button type="button" onclick="sliderClick()">生成进度条</button>
    </div>
</div>
<div id="allmap"></div>
<script type="text/javascript">
    //进度条控件部分
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "H+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }
    var dateLabel = [];
    var labelTest = ['a','b','c'];
    function sliderClick(minTime,maxTime){
        debugger;
        //销毁久的进度条
        $("#ex8").slider('destroy');
        //获取时间倍率
        var share = parseInt($("#share").val());
//        var multipleTime = 10;
        var ticks = new Array(share);
        for (var i = 0; i < share; i++){
            ticks[i] = i+1;
        }
        dateLabel = [];
        nowTime = new Date($($(".slider-tick-label")[0]).text());
        start();
        $("#ex8").slider({
            scale: 'linear',
            step: 1,
            ticks:ticks,
            ticks_labels:dateLabel,
            value:1
        });
        $("#ex8").change(function(){
            timeCount = $("#ex8").val();
            console.log($("#ex8").val());
            nowTime = new Date($($(".slider-tick-label")[timeCount-1]).text());
            $("#nowTime").text(nowTime);
            console.log(nowTime);
            start();
        });
    }

    function sliderLabel(allMin,allMax){
        //根据时间倍率计算
        var labelDate;
        var share = parseInt($("#share").val());
        var gapTime = Math.round((allMax.getTime() - allMin.getTime())/share);
        if(dateLabel.length==0){
            for(var i =1;i<=share;i++){
                labelDate = allMin.getTime() + (gapTime*i);
                labelDate = new Date(labelDate).Format("yyyy-MM-dd HH:mm:ss");
                dateLabel.push(labelDate);
            }
        }
    }

    function setSlider(minTime,maxTime){
        var singleTime = (maxTime - minTime)/30;
        var sliderTime = [];
        for(var i = 1;i<=30;i++){
            sliderTime.push((singleTime*i))
        }

//        $("#ex8").attr['data-slider-ticks-labels',"[2017/01/01 00:00:00]"]
    }
</script>
</body>
</html>
<script type="text/javascript">
    var allMin = 0;
    var allMax = 0;//所有路线的最大时间和最小时间
    var myIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/Mario.png", new BMap.Size(32, 70), {    //小车图片
        //offset: new BMap.Size(0, -5),    //相当于CSS精灵
        imageOffset: new BMap.Size(0, 0)    //图片的偏移量。为了是图片底部中心对准坐标点。
    });
    function start(){
        map.clearOverlays();//清空地图覆盖物
        num = 1;
        item = "line" + num;
        var sliderType = 0;
        while(pointA[item]!=undefined){
            pointA[item].sort(upDate);
            for(i in pointA[item]){
                var x = pointA[item][i].x;
                var y = pointA[item][i].y;
                var date = pointA[item][i].date;
                points.push(new BMap.Point(x,y));
                points[i].date = date;
            }
            if(allMin == 0){
                allMin = new Date(points[0].date);
                allMax = new Date(points[points.length-1].date);
            }
            if(allMin>new Date(points[0].date)){
                allMine = new Date(points[0].date);
            }
            if(allMax<new Date(points[points.length-1].date)){
                allMax = new Date(points[points.length-1].date);
            }
            num++;
            item = "line"+num;
            addPoint(points);
            points = [];
            //整体时间路线的最大值和最小值
        }
        if(sliderType == 0){
            sliderLabel(allMin,allMax);
            sliderType = 1;
        }

    }
    function plus(){
        var time = $("#time").val();
        time = new Date(time);
        var date = time.getDate() + 1;
        plusTime = time.getFullYear() + "/" + (time.getMonth() + 1) + "/" + date;
        $("#time").val(plusTime);
        start();
    }
        var pointA = {
            "line1":[
                { "x":102.73,
                    "y":25.04,
                    "date":"2017/01/01 00:00:00"
                },
                {
                    "x":104.06,
                    "y":30.57,
                    "date":"2017/01/03 00:00:00"
                },
                {
                    "x":106.23,
                    "y":38.48,
                    "date":"2017/01/05 00:00:00"
                },
                {
                    "x":91.17 ,
                    "y":29.65,
                    "date":"2017/01/09 00:00:00"
                }
            ],
            "line2":[
                {
                    "x":103.73,
                    "y":36.03,
                    "date":"2017/01/05 00:00:00"
                },
                {
                    "x":118.78,
                    "y":32.04,
                    "date":"2017/01/09 00:00:00"
                },
                {
                    "x":108.35,
                    "y":30.83,
                    "date":"2017/01/13 00:00:00"
                }
            ]
        }
//    var pointA = {
//        "line1":[
//            { "x":102.73,
//                "y":25.04,
//                "date":"2017/01/01 00:00:00"
//            },
//            {
//                "x":104.06,
//                "y":30.57,
//                "date":"2017/01/03 00:00:00"
//            },
//            {
//                "x":106.23,
//                "y":38.48,
//                "date":"2017/01/05 00:00:00"
//            },
//            {
//                "x":91.17 ,
//                "y":29.65,
//                "date":"2017/01/09 00:00:00"
//            },
//            {
//                "x":94.17 ,
//                "y":30.65,
//                "date":"2017/01/11 00:00:00"
//            }
//            ,
//            {
//                "x":96.17 ,
//                "y":29.65,
//                "date":"2017/01/20 00:00:00"
//            }
//            ,
//            {
//                "x":100.17 ,
//                "y":29.65,
//                "date":"2017/01/24 00:00:00"
//            }
//            ,
//            {
//                "x":103.17 ,
//                "y":29.65,
//                "date":"2017/01/25 00:00:00"
//            }
//            ,
//            {
//                "x":104.17 ,
//                "y":30.65,
//                "date":"2017/01/26 00:00:00"
//            }
//            ,
//            {
//                "x":105.17 ,
//                "y":31.65,
//                "date":"2017/02/09 00:00:00"
//            }
//            ,
//            {
//                "x":100.17 ,
//                "y":25.65,
//                "date":"2017/02/12 00:00:00"
//            }
//            ,
//            {
//                "x":110.17 ,
//                "y":29.65,
//                "date":"2017/02/15 00:00:00"
//            }
//            ,
//            {
//                "x":92.17 ,
//                "y":33.65,
//                "date":"2017/01/17 00:00:00"
//            }
//        ],
//        "line2":[
//            {
//                "x":103.73,
//                "y":36.03,
//                "date":"2017/01/05 00:00:00"
//            },
//            {
//                "x":118.78,
//                "y":32.04,
//                "date":"2017/01/09 00:00:00"
//            },
//            {
//                "x":108.35,
//                "y":30.83,
//                "date":"2017/03/13 00:00:00"
//            }
//        ]
//    }
    var map = new BMap.Map("allmap",{minZoom:5,maxZoom:11});
    map.centerAndZoom("昆明",5);
    map.addControl(new BMap.MapTypeControl());
    map.enableScrollWheelZoom(true);
    var num = 1;
    var item = "line"+num;
    var points = [];
    var nowTime;
    var oldMarker;

    function calculatedToDay(time){
        time = time/1000/60/60/24;
        return time;
    }
    function calculatedToHour(time){
        time = time/1000/60/60;
        return time;
    }
    function calculatedToMinute(time){
        teime = time/1000/60;
        return time;
    }
    function calculatedToSecond(time){
        teime = time/1000;
        return time;
    }

    //日期排序
    function upDate(x,y){
        return(x.date>y.date)?1:-1;
    }
    window.onload = function(){

    }
    function addPoint(){
        var line = [];
        var maxTime,minTime;
        var timeline = [];
        var index = 0;
//        nowTime = new Date($("#time").val());
        minTime = new Date(points[0].date);
        maxTime = new Date(points[points.length-1].date);
//        设置进度条label
//        sliderLabel(minTime,maxTime);
//        console.log("max:"+maxTime+"min:"+minTime);
        //当前时间点所在的位置
        if(nowTime>minTime&&nowTime<=maxTime){
            while(nowTime>new Date(points[index].date)){
                index++;
                console.log(index);
            }
            for(var i=index-1;i<=index;i++){
                var start,end;
                var line;
                var marker = new BMap.Marker(points[i]);
                map.addOverlay(marker);
                timeline.push(points[i]);
            }
            var polyline = new BMap.Polyline(timeline,{strokeColor:"blue",strokeWeight:2,strokeOpacity:0.5});
            map.addOverlay(polyline);
            addShow(polyline);
        }
        //完整路线图
        for(var i =0;i<points.length;i++){
            var start,end;
            start = new BMap.Label("起点"+i,{offset:new BMap.Size(20,-10)});
            end = new BMap.Label("终点"+(points.length-i),{offset:new BMap.Size(20,-10)});
            var marker = new BMap.Marker(points[i]);
            if(i == 0){
                marker.setLabel(start);
            }else if(i == points.length-1){
                marker.setLabel(end);
            }
            map.addOverlay(marker);
            var polyline = new BMap.Polyline(points,{strokeColor:"blue",strokeWeight:2,strokeOpacity:0.5});
            map.addOverlay(polyline);
        }
        line = polyline;
    }
    function addShow(polyline){
        var linePoint=polyline.getPath();//线的坐标串 (点)
        var markers=new Array();
        var carMk;
        var pixelStart;
        var pixelEnd;
        var xn;
        var yn;
        var zn;
        var nn;
        var calculatedTime;
        pixelStart=map.pointToPixel(linePoint[0]);//像素坐标转换
        pixelEnd=map.pointToPixel(linePoint[1]);
        xn=pixelEnd.x-pixelStart.x;
        yn=pixelEnd.y-pixelStart.y;
        zn=Math.sqrt(xn*xn+yn*yn);//直线长度
        nn=zn/calculatedToSecond(new Date(linePoint[1].date)-new Date(linePoint[0].date));//全长/时间差
        console.log(nn);
//            alert("I:"+i+"--xn:"+xn+"--yn:"+yn+"--zn:"+zn+"--nn:"+nn);
        var x1=0;
        var y1=0;
        var point1;
        x1=pixelStart.x+xn/zn*nn*calculatedToSecond(nowTime-new Date(linePoint[0].date));
        y1=pixelStart.y+yn/zn*nn*calculatedToSecond(nowTime-new Date(linePoint[0].date));
//像素坐标转换为经纬度坐标。
        point1=map.pixelToPoint(new BMap.Pixel(x1,y1));
        carMk = new BMap.Marker(point1,{icon:myIcon});
        markers.push(new BMap.Marker(point1),{icon:myIcon});

        map.addOverlay(carMk);
    }

</script>