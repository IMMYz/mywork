<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    body,html{
        width:100%;
        height:100%
    }
    #allmap{
        width:50%;
        height:100%;
        margin:0 auto;
    }
    #control{
        position:absolute;
        top:0;
        left:0
    }
</style>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=DE0abf6cf5580f24857faef21a4b3870"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<body>
<div id="allmap"></div>
<div id="control">
    <input id="time" type="text" />
    <button type="button" onclick="start()">开始</button>
    <label>
        一天<input type="radio" name="calculateType"/>
    </label>
    <label>
        一小时<input type="radio" name="calculateType"/>
    </label>
    <label>
        一分钟<input type="radio" name="calculateType"/>
    </label>
</div>
</body>
</html>
<script type="text/javascript">
    var myIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/Mario.png", new BMap.Size(32, 70), {    //小车图片
        //offset: new BMap.Size(0, -5),    //相当于CSS精灵
        imageOffset: new BMap.Size(0, 0)    //图片的偏移量。为了是图片底部中心对准坐标点。
    });
    function start(){
        map.clearOverlays();//清空地图覆盖物
        num = 1;
        item = "line" + num;
        while(pointA[item]!=undefined){
            pointA[item].sort(upDate);
            for(i in pointA[item]){
                var x = pointA[item][i].x;
                var y = pointA[item][i].y;
                var date = pointA[item][i].date;
                points.push(new BMap.Point(x,y));
                points[i].date = date;
            }
            num++;
            item = "line"+num;
            addPoint(points);
            points = [];
        }
    }
    var pointA = {
        "line1":[
            { "x":102.73,
                "y":25.04,
                "date":1
            },
            {
                "x":104.06,
                "y":30.57,
                "date":3
            },
            {
                "x":106.23,
                "y":38.48,
                "date":5
            },
            {
                "x":91.17 ,
                "y":29.65,
                "date":10
            }
        ],
        "line2":[
            {
                "x":103.73,
                "y":36.03,
                "date":1
            },
            {
                "x":118.78,
                "y":32.04,
                "date":15
            },
            {
                "x":108.35,
                "y":30.83,
                "date":16
            }
        ]
    }
    var map = new BMap.Map("allmap",{minZoom:5,maxZoom:11});
    map.centerAndZoom("昆明",5);
    map.addControl(new BMap.MapTypeControl());
    map.enableScrollWheelZoom(true);
    var num = 1;
    var item = "line"+num;
    var points = [];
    var nowTime;
    var oldMarker;

    function calculatedToDay(time){
        time = time/1000/60/60/24;
        return time;
    }
    function calculatedToHour(time){
        time = time/1000/60/60;
        return time;
    }
    function calculatedToMinute(time){
        teime = time/1000/60;
        return time;
    }

    //日期排序
    function upDate(x,y){
        return(x.date>y.date)?1:-1;
    }
    window.onload = function(){

    }
    function addPoint(){
        var line = [];
        var maxTime,minTime;
        var timeline = [];
        var index = 0;
        nowTime = $("#time").val();
        minTime = points[0].date;
        maxTime = points[points.length-1].date;
//        console.log("max:"+maxTime+"min:"+minTime);
        //当前时间点所在的位置
        if(nowTime>minTime&&nowTime<=maxTime){
            while(nowTime>points[index].date){
                index++;
                console.log(index);
            }
            for(var i=index-1;i<=index;i++){
                var start,end;
                var line;
                var marker = new BMap.Marker(points[i]);
                map.addOverlay(marker);
                timeline.push(points[i]);
            }
            var polyline = new BMap.Polyline(timeline,{strokeColor:"blue",strokeWeight:2,strokeOpacity:0.5});
            map.addOverlay(polyline);
            addShow(polyline);
        }
        //完整路线图
        for(var i =0;i<points.length;i++){
            var start,end;
            start = new BMap.Label("起点"+i,{offset:new BMap.Size(20,-10)});
            end = new BMap.Label("终点"+i,{offset:new BMap.Size(20,-10)});
            var marker = new BMap.Marker(points[i]);
            if(i == 0){
                marker.setLabel(start);
            }else if(i == points.length-1){
                marker.setLabel(end);
            }
            map.addOverlay(marker);
            var polyline = new BMap.Polyline(points,{strokeColor:"blue",strokeWeight:2,strokeOpacity:0.5});
            map.addOverlay(polyline);
        }
        line = polyline;
    }
    function addShow(polyline){
        var linePoint=polyline.getPath();//线的坐标串 (点)
        var markers=new Array();
        var carMk;
        var pixelStart;
        var pixelEnd;
        var xn;
        var yn;
        var zn;
        var nn;
        var calculatedTime;
        pixelStart=map.pointToPixel(linePoint[0]);//像素坐标转换
        pixelEnd=map.pointToPixel(linePoint[1]);
        xn=pixelEnd.x-pixelStart.x;
        yn=pixelEnd.y-pixelStart.y;
        zn=Math.sqrt(xn*xn+yn*yn);//直线长度
        nn=zn/(linePoint[1].date-linePoint[0].date);//全长/时间差
//            alert("I:"+i+"--xn:"+xn+"--yn:"+yn+"--zn:"+zn+"--nn:"+nn);
        var x1=0;
        var y1=0;
        var point1;
        for(var a=1;a<=(nowTime-linePoint[0].date);a++){
            x1=pixelStart.x+xn/zn*nn*a;
            y1=pixelStart.y+yn/zn*nn*a;
//像素坐标转换为经纬度坐标。
            point1=map.pixelToPoint(new BMap.Pixel(x1,y1));
            carMk = new BMap.Marker(point1,{icon:myIcon});
            markers.push(new BMap.Marker(point1),{icon:myIcon});
        }
        map.addOverlay(carMk);
    }

    function addRun(polyline) {
        var linePoint = polyline.getPath();//线的坐标串 (点)
        var markers = new Array();
        var pixelStart;
        var pixelEnd;
        var xn;
        var yn;
        var zn;
        var nn;
        pixelStart = map.pointToPixel(linePoint[0]);//像素坐标转换
        pixelEnd = map.pointToPixel(linePoint[1]);
        xn = pixelEnd.x - pixelStart.x;
        yn = pixelEnd.y - pixelStart.y;
        zn = Math.sqrt(xn * xn + yn * yn);//直线长度
        nn = zn / (linePoint[1].date - linePoint[0].date);//全长/每次移动长度
//            alert("I:"+i+"--xn:"+xn+"--yn:"+yn+"--zn:"+zn+"--nn:"+nn);
        var x1 = 0;
        var y1 = 0;
        var point1;
        for (var a = 1; a <= (nowTime - linePoint[0].date); a++) {
            x1 = pixelStart.x + xn / zn * nn * a;
            y1 = pixelStart.y + yn / zn * nn * a;
//像素坐标转换为经纬度坐标。
            point1 = map.pixelToPoint(new BMap.Pixel(x1, y1));
            var carMk = new BMap.Marker(point1, {icon: myIcon});
            markers.push(new BMap.Marker(point1), {icon: myIcon});
        }
        map.addOverlay(carMk);

        var m = 1;
        var t = setInterval(function () {
            map.addOverlay(markers[m - 1]);
            if (m != 1) {
                map.removeOverlay(markers[m - 2]);
            }
            if (m == markers.length + 1) {//运动结束
                clearInterval(t);
            }
            m++;
        }, 200);
    }
</script>